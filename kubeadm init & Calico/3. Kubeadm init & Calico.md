# Kubernetes Cluster Setup with kubeadm and Calico

This document explains how to initialize a Kubernetes cluster using **kubeadm**, configure access, understand core Kubernetes components, install **Calico** as the CNI, and fix common DNS issues caused by early networking failures.

---

## 1. Initialize the Kubernetes Control Plane

Basic command:

```bash
kubeadm init <args>
```

### (Recommended) Control Plane Endpoint
If you plan to upgrade this **single control-plane cluster** to **high availability (HA)** in the future, specify a shared control-plane endpoint:

```bash
--control-plane-endpoint <DNS-name-or-LB-IP>
```

This endpoint can be:
- A DNS name, or
- An IP address of a load balancer

---

## 2. Choose and Configure the Pod Network CIDR

Before running `kubeadm init`, choose a Pod network add-on and verify whether it requires a specific Pod CIDR.

### Recommended (for Calico)
```bash
kubeadm init --pod-network-cidr=192.168.0.0/16
```

### ‚ö†Ô∏è Important
**Pod CIDR must NOT overlap with:**
- Node CIDR
- VPC CIDR
- Any existing network in your environment

### Safe Default (use only if you are 100% sure there is no overlap)
```bash
kubeadm init --pod-network-cidr=10.244.0.0/16
```

---

## 3. Configure kubectl on the Control Plane Node

After `kubeadm init` completes:

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

Verify access:
```bash
kubectl get nodes
```

---

## 4. Kubernetes Components Installed by kubeadm

| Component               | Type       | Why |
|------------------------|------------|-----|
| kube-apiserver          | Static Pod | Bootstrap, no dependencies |
| kube-scheduler          | Static Pod | Cluster brain |
| kube-controller-manager | Static Pod | Controllers |
| etcd                    | Static Pod | Cluster state |
| kube-proxy              | DaemonSet  | Node-level networking |
| CoreDNS                 | Deployment | Cluster service, scalable |

---

## 5. Install Calico (Official Method)

```bash
curl -O https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/calico.yaml
```

---

## 6. Verify Pod CIDR in Calico Manifest

```bash
grep -n "CALICO_IPV4POOL_CIDR" calico.yaml
```

Ensure it matches the Pod CIDR used during `kubeadm init`.

---

## 7. Apply Calico

```bash
kubectl apply -f calico.yaml
```

Verify:
```bash
kubectl get pods -n kube-system
```

---

## 8. Validate Node and IP Pool

```bash
kubectl get nodes
kubectl get ippool default-ipv4-ippool -o yaml
```

---

## 9. Calico BGP Requirement (EC2)

- Calico uses **BGP**
- BGP requires **TCP port 179**
- AWS EC2 Security Groups block this by default

üëâ Open TCP 179 between all Kubernetes nodes.

---

## 10. Fix DNS Issues (if observed)

If DNS does not work inside Pods:

```bash
kubectl -n kube-system rollout restart ds kube-proxy
kubectl -n kube-system rollout restart deployment coredns
```

---

## Summary

- kubeadm initializes the control plane
- Pod CIDR must match between kubeadm and Calico
- Calico BGP requires TCP 179 on EC2
- Restart kube-proxy and CoreDNS after fixing networking

Happy Kubernetes learning üöÄ
